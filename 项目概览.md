读取 [](file:///e%3A/program_files/bjsys/BeiJianHuTong/SparePart/models.py)

读取 [](file:///e%3A/program_files/bjsys/BeiJianHuTong/sites/models.py)

读取 [](file:///e%3A/program_files/bjsys/BeiJianHuTong/accounts/models.py)

读取 [](file:///e%3A/program_files/bjsys/BeiJianHuTong/BeiJianHuTong/settings.py)

读取 [](file:///e%3A/program_files/bjsys/BeiJianHuTong/BeiJianHuTong/urls.py)

读取 [](file:///e%3A/program_files/bjsys/BeiJianHuTong/requirements.txt)

读取 [](file:///e%3A/program_files/bjsys/front/my-vue-app/API_DOCUMENT.md#1-1)，行 1 到 400

读取 [](file:///e%3A/program_files/bjsys/front/my-vue-app/DATABASE_SCHEMA.md#1-1)，行 1 到 400

读取 [](file:///e%3A/program_files/bjsys/BeiJianHuTong/SparePart/views.py)

读取 [](file:///e%3A/program_files/bjsys/BeiJianHuTong/SparePart/urls.py)

读取 [](file:///e%3A/program_files/bjsys/BeiJianHuTong/accounts/urls.py)

读取 [](file:///e%3A/program_files/bjsys/BeiJianHuTong/accounts/views.py)

读取 [](file:///e%3A/program_files/bjsys/BeiJianHuTong/sites/views.py)

读取 [](file:///e%3A/program_files/bjsys/BeiJianHuTong/sites/urls.py)

读取 [](file:///e%3A/program_files/bjsys/BeiJianHuTong/SparePart/serializers.py)

读取 [](file:///e%3A/program_files/bjsys/BeiJianHuTong/sites/serializers.py)

读取 [](file:///e%3A/program_files/bjsys/BeiJianHuTong/SparePart/urls.py)

读取 [](file:///e%3A/program_files/bjsys/front/my-vue-app/README.md)

读取 [](file:///e%3A/program_files/bjsys/front/my-vue-app/src/router/index.ts)

读取 [](file:///e%3A/program_files/bjsys/front/my-vue-app/src/services/api.ts)

读取 [](file:///e%3A/program_files/bjsys/front/my-vue-app/src/services/partsApi.ts)

读取 [](file:///e%3A/program_files/bjsys/front/my-vue-app/src/stores/parts.ts)

读取 [](file:///e%3A/program_files/bjsys/front/my-vue-app/src/stores/user.ts)

**备件系统复刻指南**

- 项目组成：后端 Django + Django REST Framework + MySQL + JWT；前端 Vue 3 + TypeScript + Vite + Pinia + Axios（含 Element Plus 消息拦截）。
- 代码入口：后端位于 BeiJianHuTong，前端位于 my-vue-app。
- 运行目标：提供多场站备件库存管理、分类、出入库流水、简单权限隔离（按场站）、基础图片上传与 JWT 认证。

---

### 1. 后端概览（Django REST）
- 核心模型  
  - 场站：见 sites/models.py。字段包含 `name`/`code`/地址/联系人等。  
  - 分类：见 SparePart/models.py 中 `Category`。  
  - 备件：同文件 `SparePart`，包含数量、预警、分类、场站、图片、供应商、采购周期、状态、创建/更新人等。`unique_together(name, site)` 限制同场站重名。  
  - 出入库：`SparePartTransaction` 记录 in/out，`save()` 时自动更新库存与最近采购/使用时间。  
  - 用户：自定义 `accounts.User`（扩展自 `AbstractUser`），增加场站关联与权限标记，见 accounts/models.py。
- 认证与权限  
  - JWT：登录/刷新由 `rest_framework_simplejwt` 提供（/api/auth/login/, /api/auth/refresh/）。  
  - 用户信息：/api/auth/me/ 返回用户及场站权限；/api/auth/logout/ 由前端清 Token。  
  - 视图权限：所有资源视图均要求 `IsAuthenticated`。备件列表会根据用户能否查看所有场站自动过滤为所属场站。
- 路由与端点（见 BeiJianHuTong/urls.py、SparePart/urls.py、sites/urls.py、accounts/urls.py）
  - 认证：`POST /api/auth/login/`, `POST /api/auth/refresh/`, `GET /api/auth/me/`, `POST /api/auth/logout/`
  - 场站：`GET /api/sites/` (只读)
  - 分类：`/api/categories/`（CURD）
  - 备件：`/api/spare-parts/`（列表/检索/创建/更新/删除），支持 query：`category_id`、`site_id`、`status`、`search`、分页 `page/limit`
  - 出入库：`/api/transactions/`（列表、创建，支持筛选 spare_part_id/transaction_type/time range）；`/api/transactions/by_spare_part?spare_part_id=`；`/api/transactions/statistics/` 汇总 in/out 次数与数量。
- 序列化与自动逻辑  
  - SparePart/serializers.py 将 `alarm_qty/procurement_days` 映射为前端字段，生成 `imageUrl/stationName/categoryName` 等只读展示字段。  
  - 事务序列化器支持“输入备件名 + 场站”自动创建备件（快速入库）。
  - 备件创建时若未显式提供 `siteId`，回落到用户所属场站；更新会自动写入 `updated_by`。
- 设置与依赖  
  - 关键配置：MySQL 连接、`AUTH_USER_MODEL=accounts.User`、CORS 允许 `http://localhost:5173` 且已放开全部源，媒体目录 `/media/`，静态目录 `static/`。见 BeiJianHuTong/settings.py。  
  - 依赖：Django 4.2、DRF、simplejwt、cors-headers、mysqlclient、Pillow（见 requirements.txt）。

---

### 2. 前端概览（Vue 3 + TS + Vite）
- 路由：见 src/router/index.ts。  
  - `/parts` 列表、`/parts/new` 创建、`/parts/:id` 详情、`/parts/:id/edit` 编辑。
- 状态与 API  
  - Axios 实例与拦截器：附加 Bearer Token、统一错误提示，见 src/services/api.ts。  
  - 业务 API 包装：站点、分类、备件、出入库，见 src/services/partsApi.ts。  
  - Pinia：`usePartsStore` 管理列表/分类/站点/事务，见 src/stores/parts.ts；`useUserStore` 管理登录与当前场站，见 src/stores/user.ts。
- 页面与组件（位于 src/pages 与 src/components）
  - `PartsList.vue`：拉取备件列表，支持筛选/分页/搜索。
  - `PartDetail.vue`：展示单条备件及交易记录。
  - `PartForm.vue`：创建/编辑备件。
  - `PermissionWrapper.vue`：基于用户权限控制可见性；`AuthComponent.vue` 处理登录交互；`Navbar.vue` 导航与场站选择。
- 样式与入口：`App.vue`、`main.ts` 挂载 Pinia + Router，基础样式在 `style.css`。

---

### 3. 数据与接口设计要点
- 真实实现 vs 文档：前端附带的 API_DOCUMENT.md 与 DATABASE_SCHEMA.md 描述了更完整的理想接口/表设计；当前后端实际端点以 Django 代码为准（RESTful + JWT）。  
- 备件字段映射：`quantity` ↔ `qty`（文档示例），当前后端字段名为 `quantity`；预警 `alarm_qty` 在序列化器暴露为 `alarmQty`；站点 ID 通过 `siteId` 写入、`stationId` 只读展示。  
- 权限模型：后端以用户的 `site` + `can_view_all_sites` 控制列表过滤；创建/更新/删除不再依赖前端校验。  
- 库存更新原则：事务创建时自动增减库存并记录时间戳；删除备件会级联删除其交易记录（外键 CASCADE）。

---

### 4. 复刻步骤（本地开发）
#### 后端
1) 准备环境  
```bash
cd BeiJianHuTong
python -m venv .venv
.\.venv\Scripts\activate  # PowerShell
pip install -r requirements.txt
```
2) 配置 MySQL  
- 创建数据库 beijianhutong，更新 BeiJianHuTong/settings.py 中的 `USER/PASSWORD/HOST/PORT` 如有不同。  
3) 迁移与超管  
```bash
python manage.py migrate
python manage.py createsuperuser
```
4) 启动开发服务器（含媒体服务）  
```bash
python manage.py runserver 0.0.0.0:8000
```
5) （可选）上传图片：保证 `media/` 目录可写；ImageField 会将文件存到 `media/spare_parts/`。
6) API 快速检查  
- JWT 登录：`POST /api/auth/login/`，获取 `access` 存入前端 localStorage。  
- 备件列表：`GET /api/spare-parts/?site_id=1&search=xxx`。  
- 出入库：`POST /api/transactions/`（可传 `spare_part_name_input`+`spare_part_site_id` 自动建备件）。

#### 前端
1) 安装依赖  
```bash
cd front/my-vue-app
npm install
```
2) 配置环境  
- 新建 `.env.local`（或使用现有 Vite 变量）：  
```
VITE_API_BASE_URL=http://localhost:8000/api
```
3) 启动开发服务器  
```bash
npm run dev -- --host --port 5173
```
4) 登录与体验  
- 使用后端创建的用户登录；Token 自动存入 `localStorage`。  
- 选择场站后即可查看/编辑对应备件；无全站权限的用户仅能看到/操作所属场站数据。

---

### 5. 关键实现原理（简述）
- REST & 路由：DRF `ModelViewSet` + `DefaultRouter` 自动生成 CRUD 路由，减少样板代码。
- JWT：`simplejwt` 中的 `TokenObtainPairView` 发放 `access/refresh`；前端拦截器把 Token 写入 `Authorization: Bearer` 头，401 时清除本地 Token。
- 跨域：`django-cors-headers` 置于最前的中间件，允许来自 Vite 开发端口的请求，已放开所有源以便调试。
- 序列化/验证：`ModelSerializer` 将数据库字段映射到前端友好字段并做校验；事务序列化器支持“缺件时自动创建”以兼顾录入效率。
- 库存一致性：`SparePartTransaction.save()` 钩子在首次保存时原子更新库存与时间戳，避免重复累加；视图层再包装统一响应格式 `{code, message, data}` 方便前端解析。
- 前端状态：Pinia 作为单一数据源，API 返回格式兼容 `{items, total}` 或 `{results, count}`，降低后端耦合；Axios 响应拦截统一错误提示与 401 处理。

---

### 6. 可扩展与改进建议
- 权限细化：为不同角色定义 DRF Permission，限制删除或跨场站访问；对 transactions 增加操作人/场站校验。
- 日志与审计：实现库存变更的审计表（参考 DATABASE_SCHEMA 的 `inventory_logs`），并在备件更新时写入。
- 上传与 CDN：为图片字段提供直传/签名上传，或在序列化器中接收 Base64 并落盘。
- 搜索优化：当前 `name__icontains`/`model__icontains` 可换为全文索引或 Django-MySQL fulltext。
- 部署：关闭 `DEBUG`，设置可信主机；使用 Nginx 反向代理 + uWSGI/Gunicorn，静态文件 `collectstatic`，媒体目录持久化。