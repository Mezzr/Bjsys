# 备件管理系统 - 路由组件内容总结

## 概览

系统共有 **5 条路由**，对应 **3 个页面组件**，以下是详细的路由映射和内容说明。

---

## 1. 路由配置表

| 路由路径 | 路由名称 | 组件 | 类型 | 说明 |
|---------|---------|------|------|------|
| `/` | - | 重定向 | 重定向 | 重定向到 `/parts` |
| `/parts` | `PartsList` | PartsList.vue | 列表页 | 备件列表，支持搜索、过滤、多场站切换 |
| `/parts/new` | `PartCreate` | PartForm.vue | 创建页 | 创建新备件（仅限本场站） |
| `/parts/:id` | `PartDetail` | PartDetail.vue | 详情页 | 查看备件详细信息（所有人可见） |
| `/parts/:id/edit` | `PartEdit` | PartForm.vue | 编辑页 | 编辑备件（仅限本场站） |

---

## 2. 详细组件说明

### 2.1 首页 - `/` (重定向)

**路由路径**: `/`  
**重定向到**: `/parts`  
**说明**: 用户访问根路径时自动重定向到备件列表页

---

### 2.2 列表页 - `/parts` (PartsList.vue)

#### 📋 页面功能

| 功能 | 说明 | 权限 |
|------|------|------|
| 备件卡片展示 | 网格布局，每张卡片显示备件信息 | 所有人可见 |
| 搜索过滤 | 按名称、型号、场站实时搜索 | 所有人可用 |
| 告警提示 | 库存 ≤ 告警阈值时红色突出显示 | 所有人可见 |
| 场站切换 | 弹窗选择查看其他场站的备件 | 所有人可用 |
| 新增备件 | 创建新备件（仅限本场站） | 本场站用户可用 |
| 编辑备件 | 编辑备件信息（仅限本场站） | 本场站用户可用 |
| 查看详情 | 跳转到详情页查看完整信息 | 所有人可用 |

#### 📦 页面显示内容

**页面布局**:
```
┌─────────────────────────────────────────────────────┐
│  标题：备件列表                                      │
│  当前场站: [station-1 🏠] ▼  （我的场站）           │
│                                [+ 新增备件]          │
├─────────────────────────────────────────────────────┤
│  搜索框: ☐ 搜索备件名称、型号或场站...  共 X 件备件│
├─────────────────────────────────────────────────────┤
│  备件卡片网格 (auto-fill, 320px)                    │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐           │
│  │ 图片区域 │  │ 图片区域 │  │ 图片区域 │           │
│  │(180px高)│  │(180px高)│  │(180px高)│           │
│  │⚠️ 告警  │  │         │  │         │           │
│  ├──────────┤  ├──────────┤  ├──────────┤           │
│  │备件名称  │  │备件名称  │  │备件名称  │           │
│  │─────────│  │─────────│  │─────────│           │
│  │型号:... │  │型号:... │  │型号:... │           │
│  │位置:... │  │位置:... │  │位置:... │           │
│  │数量:10 ⚠│  │数量:50  │  │数量:3  │           │
│  │阈值:3   │  │阈值:-   │  │阈值:5  │           │
│  │周期:7天 │  │周期:14天│  │周期:-   │           │
│  │场站:... │  │场站:... │  │场站:... │           │
│  │         │  │         │  │         │           │
│  │[编辑][详情]│ │[编辑][详情]│ │[无权限][详情]│     │
│  └──────────┘  └──────────┘  └──────────┘           │
│  （本场站告警卡片用红色边框和阴影突出）              │
└─────────────────────────────────────────────────────┘
```

**备件卡片内容**:

卡片显示以下字段：
1. **图片区域** (180px 高)
   - 显示备件图片或占位符
   - 告警时右上角红色徽章 "⚠️ 告警"

2. **备件名称** (蓝色，可点击进入详情)
   - 支持中文名称

3. **信息表格** (13px 字体)
   - 备件适用型号: `p.model` 或 "未设置"
   - 存放位置: `p.location` 或 "未设置"
   - 当前数量: `p.qty`（告警时红色）+ ⚠️ 图标
   - 告警阈值: `p.alarmQty`（当 qty ≤ alarmQty 时显示）
   - 采购周期: `p.procurementDays` 天（可选）
   - 所属场站: `p.stationId`

4. **备件描述** (可选)
   - 灰色字体，12px，最多显示 2-3 行

5. **操作按钮** (2 个)
   - 编辑 / 无编辑权限（灰色禁用）
   - 详情（灰色边框）

**告警样式**:
- 当 `qty <= alarmQty` 时：
  - 红色边框 3px (#ff4d4f)
  - 红色发光阴影
  - 浅橙色背景 (#fffbf0)
  - 缩放效果 (scale 1.02)

**场站选择弹窗** (固定位置，居中):
```
┌──────────────────────────┐
│ 选择场站                  │
├──────────────────────────┤
│ ☐ station-1             │
│   ✓ 我的场站   已选择 ✓  │
├──────────────────────────┤
│ ☐ station-2             │
│                          │
├──────────────────────────┤
│             [关闭]        │
└──────────────────────────┘
```

#### 🎨 样式特点
- 响应式网格: `repeat(auto-fill, minmax(320px, 1fr))`
- 卡片圆角: 6px
- 过渡动画: all 0.3s
- 鼠标悬停: 阴影增强效果

#### 🔐 权限控制
- 查看备件: ✅ 所有人可见所有场站的备件
- 新增备件: ✅ 仅本场站用户可用（其他用户看到 "仅可在自己的场站新增备件"）
- 编辑备件: ✅ 仅本场站用户可编辑（按钮显示为 "无编辑权限"）
- 搜索/过滤: ✅ 所有人可用

---

### 2.3 详情页 - `/parts/:id` (PartDetail.vue)

#### 📋 页面功能

| 功能 | 说明 |
|------|------|
| 查看完整信息 | 显示备件所有详细信息 |
| 编辑跳转 | 有权限则显示"编辑备件"按钮 |
| 权限提示 | 无权限时显示 "您无编辑权限" 提示 |
| 返回列表 | "返回"按钮回到上一页 |

#### 📦 页面显示内容

**页面布局**: 两列网格

```
┌──────────────────────────────────────────────────┐
│  标题: 备件详情 - 滤芯 A           [← 返回]       │
├───────────────────────┬──────────────────────────┤
│   左列：大图片        │   右列：信息表格          │
│   (400px 高)         │                          │
│   ┌─────────────────┐ │  备件名称: 滤芯 A        │
│   │                 │ │  备件型号: XYZ-2000    │
│   │   [图片展示]    │ │  存放位置: A区3排2柜   │
│   │  object-fit:   │ │  当前库存: 10 件 (蓝)   │
│   │  contain       │ │  告警数量: 3 件 (红)    │
│   │                 │ │  采购周期: 7 天        │
│   │                 │ │  所属场站: station-1   │
│   └─────────────────┘ │  描述: 用于 XYZ 系列... │
│                       │  ─────────────────────  │
│                       │  [编辑备件] ⚠️ 权限提示 │
└───────────────────────┴──────────────────────────┘
```

**显示字段**:

| 字段 | 数据来源 | 说明 |
|------|--------|------|
| 备件名称 | `part.name` | 在页面标题和表格中显示 |
| 备件适用型号 | `part.model` | 显示或 "未设置" |
| 存放位置 | `part.location` | 显示或 "未设置" |
| 当前库存 | `part.qty` | 蓝色字体加粗 |
| 告警数量 | `part.alarmQty` | 红色字体（可选） |
| 采购周期 | `part.procurementDays` | 单位：天（可选） |
| 所属场站 | `part.stationId` | 灰色字体 |
| 描述 | `part.desc` | 表格最后一行，显示 "无" 如果为空 |
| 大图片 | `part.imageUrl` | 左侧区域展示 |

**操作区域**:
- 有权限: 显示 "编辑备件" 按钮（蓝色）
- 无权限: 显示 "⚠️ 您无编辑权限（仅限本场站编辑）" 提示（橙色）

#### 🔐 权限控制
- 查看信息: ✅ 所有人可见
- 编辑按钮: ✅ 仅本场站用户显示（`userStore.user?.stationId === part.stationId`）

#### 🎨 样式特点
- 两列布局: `grid-template-columns: 1fr 1fr`
- 图片容器: `min-height: 300px`, `max-height: 400px`
- 表格样式: 简洁无边框
- 字体: 14px

---

### 2.4 创建/编辑页 - `/parts/new` 和 `/parts/:id/edit` (PartForm.vue)

#### 📋 页面功能

| 功能 | 创建页 | 编辑页 |
|------|--------|--------|
| 表单预填 | ❌ 空表单 | ✅ 加载现有数据 |
| 场站字段 | 只读（当前用户场站） | 只读（原始场站） |
| 提交按钮 | "创建" | "更新" |
| 权限检查 | ✅ 自动设置为当前用户场站 | ✅ 检查是否为本场站 |
| 返回位置 | 返回列表页 | 返回详情页 |

#### 📦 页面显示内容

**表单布局**: 单列表单，max-width: 600px

```
┌──────────────────────────────────────────┐
│ 标题: 新增备件 (或 编辑备件)              │
├──────────────────────────────────────────┤
│ ❌ 错误提示 (如有)                        │
│ [红色背景，警告信息]                     │
├──────────────────────────────────────────┤
│ □ 备件名称 *                             │
│   [输入框 - 必填]                        │
├──────────────────────────────────────────┤
│ □ 备件适用型号                           │
│   [输入框 - 可选，如 FC-2000]             │
├──────────────────────────────────────────┤
│ □ 存放位置                               │
│   [输入框 - 可选，如 仓库 A - 第2排]      │
├──────────────────────────────────────────┤
│ □ 当前数量 *    □ 告警数量                │
│ [数字输入框]    [数字输入框]              │
├──────────────────────────────────────────┤
│ □ 采购周期（天）                          │
│   [数字输入框 - 可选，如 7]               │
├──────────────────────────────────────────┤
│ □ 场站 * (编辑时只读)                    │
│   [输入框 - 必填，通常只读]               │
├──────────────────────────────────────────┤
│ □ 备件描述                               │
│   [文本框，min-height: 80px]              │
│   备件说明、用途等                       │
├──────────────────────────────────────────┤
│ □ 备件图片                               │
│   [文件选择框] 支持 JPG、PNG 等           │
│   [图片预览 80x80px (可选)]               │
├──────────────────────────────────────────┤
│ [创建/更新] [返回]                        │
└──────────────────────────────────────────┘
```

**表单字段详情**:

| 字段名 | 数据字段 | 类型 | 必填 | 说明 |
|------|--------|------|------|------|
| 备件名称 | `form.name` | text | ✅ | 备件标识，不能为空 |
| 备件适用型号 | `form.model` | text | ❌ | 如 "XYZ-2000"，可选 |
| 存放位置 | `form.location` | text | ❌ | 如 "A区第3排第2个柜"，可选 |
| 当前数量 | `form.qty` | number | ✅ | 库存数量，默认 0 |
| 告警数量 | `form.alarmQty` | number | ❌ | 库存告警阈值，可选 |
| 采购周期 | `form.procurementDays` | number | ❌ | 单位天数，可选 |
| 场站 | `form.stationId` | text | ✅ | 创建时只读(当前用户场站)，编辑时只读 |
| 备件描述 | `form.desc` | textarea | ❌ | 长文本说明 |
| 备件图片 | `form.imageUrl` | file + preview | ❌ | 上传图片，生成 Data URL |

**表单验证**:
- `name` 不能为空 → "备件名称不能为空"
- `stationId` 不能为空 → "场站不能为空"
- 编辑时校验权限 → "无权限编辑非本场站备件"

**操作按钮**:
- 提交按钮:
  - 创建页: "创建" → 创建成功后返回列表 `/parts`
  - 编辑页: "更新" → 更新成功后返回详情页 `/parts/:id`
- 返回按钮: 返回上一页 (`router.back()`)

**图片上传处理**:
1. 用户选择图片 (`<input type="file" accept="image/*">`)
2. 触发 `handleImageUpload()` 事件
3. 使用 FileReader 读取文件
4. 转换为 Base64 Data URL: `data:image/jpeg;base64,...`
5. 保存到 `form.imageUrl`
6. 右侧显示 80x80px 缩略图预览

#### 🔐 权限控制
- 创建备件: ✅ 仅当前用户场站
  - 自动填充 `stationId = userStore.user?.stationId`
  - 创建时强制使用当前用户场站
- 编辑备件: ✅ 仅本场站用户可编辑
  - 加载时检查: `if (user.stationId !== part.stationId)` → 显示错误 "您无权限编辑非本场站的备件"
  - 提交时再次校验权限
  - 场站字段只读（`:readonly="isEdit"`）

#### 🎨 样式特点
- 表单宽度: max-width 600px
- 网格布局: 数量和告警数量并排 (`grid-template-columns: 1fr 1fr`)
- 输入框统一: 8px padding, 1px border, 4px border-radius
- 文本框: min-height 80px
- 图片预览: 80x80px, object-fit: cover
- 提交区域: 上方 border-top，与上面内容分隔

---

## 3. 页面导航流程

```
首页 (/)
    ↓ 重定向
列表页 (/parts)  ← 主入口
    ├→ 点击"新增备件" → 创建页 (/parts/new)
    │                      ↓ 创建成功
    │                    返回列表页
    │
    ├→ 点击"编辑" → 编辑页 (/parts/:id/edit)
    │ (需权限)       ↓ 更新成功
    │             返回详情页
    │
    └→ 点击"详情" 或 卡片名称 → 详情页 (/parts/:id)
                              ↓ 点击"编辑备件"
                            编辑页 (/parts/:id/edit)
                              ↓ 点击"返回"
                            返回详情页
```

---

## 4. 数据流动

### 4.1 数据获取流程

```
PartsList.vue (列表页)
    ├─ onMounted
    │  ├─ fetchMe() → 获取当前用户信息
    │  └─ fetchParts(stationId) → 加载该场站的所有备件
    │     └─ 存储到 parts.value (响应式数组)
    │
    ├─ 计算属性 filteredParts
    │  ├─ 应用搜索过滤
    │  └─ 按告警优先级排序
    │
    └─ v-for 遍历渲染卡片

PartDetail.vue (详情页)
    ├─ onMounted
    │  ├─ fetchMe() → 获取当前用户
    │  └─ getPart(id) → 从 store 查询单个备件
    │     └─ 存储到 part.value
    │
    └─ 检查 canEdit() → 是否有编辑权限

PartForm.vue (表单页)
    ├─ onMounted
    │  ├─ fetchMe() → 获取当前用户
    │  ├─ IF 编辑模式
    │  │  ├─ getPart(id) → 加载备件数据
    │  │  └─ Object.assign(form, part) → 预填表单
    │  └─ ELSE 创建模式
    │     └─ form.stationId = userStore.user.stationId
    │
    └─ submit() 时
       ├─ 表单验证
       ├─ 权限检查
       ├─ createPart(form) 或 updatePart(id, form)
       └─ 导航到相应页面
```

### 4.2 数据源

所有数据都来自两个 Pinia Store：

**useUserStore**:
```typescript
{
  user: { id, name, stationId, token },
  selectedStationId: string,  // 当前选中场站 ID
  getCurrentViewType(): 'own' | 'other'  // 判断是否本场站
}
```

**usePartsStore**:
```typescript
{
  parts: Part[],  // 所有备件数组
  fetchParts(stationId?) → Part[]  // 获取备件列表（可过滤）
  getPart(id) → Part  // 获取单个备件
  createPart(data) → void  // 创建
  updatePart(id, data) → void  // 更新
  deletePart(id) → void  // 删除（未在 UI 中使用）
}
```

---

## 5. 权限矩阵

### 5.1 功能权限

| 功能 | 所有人 | 本场站用户 | 其他场站用户 |
|------|--------|----------|----------|
| 查看所有备件列表 | ✅ | ✅ | ✅ |
| 搜索/过滤 | ✅ | ✅ | ✅ |
| 查看备件详情 | ✅ | ✅ | ✅ |
| 查看图片 | ✅ | ✅ | ✅ |
| 新增备件 | ❌ | ✅ | ❌ |
| 编辑备件 | ❌ | ✅ | ❌ |
| 删除备件 | ❌ | ❌ | ❌ (未实现) |

### 5.2 按钮显示

| 按钮 | 条件 | 状态 |
|------|------|------|
| "+ 新增备件" | `selectedStationId === user.stationId` | 显示，可点击 |
|  | `selectedStationId !== user.stationId` | 隐藏，显示提示文本 |
| "编辑" | `part.stationId === user.stationId` | 显示，可点击（蓝色） |
|  | `part.stationId !== user.stationId` | 显示，禁用（灰色 "无编辑权限"） |
| "编辑备件" (详情页) | `part.stationId === user.stationId` | 显示，可点击 |
|  | `part.stationId !== user.stationId` | 隐藏，显示权限提示 |

---

## 6. 路由参数说明

| 路由 | 参数 | 参数名 | 类型 | 说明 |
|------|------|--------|------|------|
| `/parts/:id` | ✅ | `id` | string | 备件 ID（UUID） |
| `/parts/:id/edit` | ✅ | `id` | string | 备件 ID（UUID） |

---

## 7. 页面样式特点

| 页面 | 布局 | 宽度限制 | 颜色主题 |
|------|------|--------|--------|
| PartsList | 响应式网格 | 无（全屏） | 蓝色#1890ff + 红色#ff4d4f |
| PartDetail | 两列 (1fr 1fr) | max-width 1000px | 蓝色 + 灰色 |
| PartForm | 单列 | max-width 600px | 蓝色 + 警告橙色 |

---

## 8. 特殊组件

### 8.1 告警提示系统

**触发条件**: `qty <= alarmQty`

**显示位置**:
1. **列表页卡片**:
   - 红色边框 (3px #ff4d4f)
   - 红色发光阴影
   - 浅橙色背景 (#fffbf0)
   - 缩放效果 (scale 1.02)
   - 右上角红色徽章 "⚠️ 告警"
   - 数量字段红色 + 警告图标

2. **详情页**:
   - 告警数量字段显示为红色

3. **排序**:
   - 列表页自动将告警备件排在最前面

### 8.2 场站选择弹窗

**触发**: 点击"当前场站"按钮

**弹窗内容**:
- 显示所有可用场站列表
- 当前选中场站高亮 (蓝色背景)
- 用户的场站标记 "✓ 我的场站" (绿色)
- 右侧显示 "已选择" 状态

**动画**: 弹窗进入 scale(0.9) → scale(1), opacity 0 → 1 (300ms)

---

## 9. 总结表格

| 指标 | PartsList | PartDetail | PartForm |
|------|----------|-----------|----------|
| 路由路径 | `/parts` | `/parts/:id` | `/parts/new` 或 `/parts/:id/edit` |
| 组件文件 | PartsList.vue | PartDetail.vue | PartForm.vue |
| 主要功能 | 列表、搜索、过滤、切换 | 查看详情、编辑跳转 | 创建/编辑备件 |
| 可见数据 | 备件卡片×N | 完整备件信息 | 表单字段×9 |
| 权限检查 | ✅ 编辑按钮条件 | ✅ 编辑按钮条件 | ✅ 加载时 + 提交时 |
| 响应式 | ✅ 网格布局 | ✅ 两列响应式 | ✅ 单列 max-width |
| 特殊功能 | 告警排序/显示、场站选择 | 无 | 图片上传预览 |

