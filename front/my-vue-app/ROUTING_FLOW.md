# 路由流程图及访问流程说明

## 1. 应用路由流程图

```
┌─────────────────────────────────────────────────────────┐
│                   浏览器访问                              │
│              http://localhost:5174/                      │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
        ┌────────────────────────────┐
        │   检查用户认证状态          │
        │  (getUserFromLocalStorage)  │
        └────┬───────────────────┬───┘
             │                   │
          YES │                 NO │
             │                   │
             ▼                   ▼
      ┌──────────────┐   ┌──────────────┐
      │ 用户已登录   │   │  跳转登录页  │
      │             │   │ /login页面   │
      └──────┬───────┘   └──────┬───────┘
             │                   │
             │         ┌─────────┴─────────┐
             │         │                   │
             │         ▼                   ▼
             │    ┌─────────────┐   ┌─────────────┐
             │    │ 输入用户信息 │   │ 密码错误    │
             │    │ 点击登录    │   │ 重新登录    │
             │    └──────┬──────┘   └─────────────┘
             │           │
             │           ▼
             │    ┌─────────────┐
             │    │ 验证成功    │
             │    │ 存储token   │
             │    └──────┬──────┘
             │           │
             └───────┬───┘
                     │
                     ▼
        ┌────────────────────────────────┐
        │   App.vue (根布局组件)          │
        │  - 显示header和用户信息        │
        │  - 渲染router-view             │
        └────────────────┬───────────────┘
                         │
                         ▼
        ┌────────────────────────────────┐
        │   onMounted: fetchMe()          │
        │   - 获取当前用户信息           │
        │   - 初始化selectedStationId    │
        └────────────────┬───────────────┘
                         │
                         ▼
        ┌────────────────────────────────┐
        │   路由导向判断                  │
        └────┬──────────────┬──────┬──────┘
             │              │      │
             ▼              ▼      ▼
        ┌──────────┐  ┌──────────┐  ┌──────────┐
        │/parts    │  │/parts/:id│  │/parts/:id│
        │(列表页)  │  │(详情页)  │  │/edit     │
        │          │  │          │  │(编辑页)  │
        └──────────┘  └──────────┘  └──────────┘
             │              │              │
             ▼              ▼              ▼
        ┌──────────┐  ┌──────────┐  ┌──────────┐
        │PartsList │  │PartDetail│  │PartForm  │
        │组件      │  │组件      │  │组件      │
        └──────────┘  └──────────┘  └──────────┘
```

## 2. 详细访问流程

### 2.1 第一次访问网站流程

```
步骤1: 用户打开浏览器输入 http://localhost:5174/
  ├─ 请求被 router 拦截
  └─ 检查 localStorage 中是否有 token

步骤2: localStorage 无 token
  ├─ 重定向到 /login (需要实现的登录页)
  └─ 显示登录表单

步骤3: 用户输入用户名/密码点击登录
  ├─ 请求 POST /api/auth/login
  ├─ 后端返回 { token, user: { id, name, stationId } }
  ├─ 前端保存 token 到 localStorage
  └─ 保存 user 到 Pinia userStore

步骤4: 登录成功跳转到 /parts
  ├─ App.vue 挂载，调用 userStore.fetchMe()
  ├─ 获取当前登录用户信息
  ├─ 初始化 selectedStationId = user.stationId
  └─ PartsList 组件挂载，加载该场站的备件列表

步骤5: 显示备件列表页面
  ├─ 显示当前场站名称 (如: station-1)
  ├─ 显示"新增备件"按钮 (仅限本场站)
  ├─ 显示搜索框
  └─ 显示备件卡片网格
```

### 2.2 用户在列表页的交互流程

```
┌─ 用户在 PartsList 页面
│
├─ 交互1: 搜索备件
│  └─ 输入搜索关键词 → 实时过滤显示
│
├─ 交互2: 查看备件详情
│  ├─ 点击"详情"按钮 → 跳转 /parts/:id
│  ├─ PartDetail 组件显示
│  └─ 显示完整的备件信息 (带图片)
│
├─ 交互3: 编辑备件 (仅限本场站)
│  ├─ 点击"编辑"按钮 → 跳转 /parts/:id/edit
│  ├─ PartForm 组件加载该备件数据
│  ├─ 用户修改信息及图片
│  ├─ 点击"提交"按钮 → 调用 updatePart()
│  └─ 返回列表页，显示更新后的数据
│
├─ 交互4: 创建新备件 (仅限本场站)
│  ├─ 点击"新增备件"按钮 → 跳转 /parts/new
│  ├─ PartForm 组件显示空表单
│  ├─ 用户填写信息并上传图片
│  ├─ 点击"创建"按钮 → 调用 createPart()
│  └─ 返回列表页，新备件显示在列表中
│
└─ 交互5: 切换查看其他场站的备件
   ├─ 点击"当前场站"按钮 → 打开场站选择弹窗
   ├─ 弹窗显示所有可用场站列表
   ├─ 标记用户的场站 (🏠 我的场站)
   ├─ 点击要查看的场站 → 设置 selectedStationId
   ├─ 重新加载该场站的备件列表
   ├─ "新增备件"按钮变灰 (非本场站)
   ├─ 所有"编辑"按钮变灰 (无编辑权限)
   └─ 返回列表页，显示其他场站的备件
```

### 2.3 详情页的交互流程

```
┌─ 用户在 PartDetail 页面
│
├─ 显示信息
│  ├─ 左列: 备件大图 (或默认图)
│  └─ 右列: 完整信息表格
│     ├─ 备件名称
│     ├─ 备件适用型号
│     ├─ 存放位置
│     ├─ 当前数量
│     ├─ 告警阈值
│     ├─ 采购周期
│     ├─ 场站信息
│     └─ 备件描述
│
├─ 权限判断
│  ├─ IF 当前用户场站 == 备件场站
│  │  └─ 显示"编辑备件"按钮
│  └─ ELSE
│     └─ 显示"您无编辑权限"提示
│
└─ 用户操作
   ├─ 点击"编辑备件" → 跳转到编辑页 /parts/:id/edit
   └─ 点击"返回" → 回到列表页 /parts
```

### 2.4 表单页的交互流程 (编辑/创建)

```
┌─ 用户在 PartForm 页面
│
├─ 模式判断
│  ├─ IF route.params.id 存在
│  │  ├─ 编辑模式: 加载该备件的现有数据
│  │  └─ 按钮显示: "提交"
│  └─ ELSE
│     ├─ 创建模式: 显示空表单
│     └─ 按钮显示: "创建"
│
├─ 表单字段
│  ├─ 备件名称 * (必填)
│  ├─ 备件适用型号
│  ├─ 存放位置
│  ├─ 当前数量 * (必填)
│  ├─ 告警阈值
│  ├─ 采购周期 (天)
│  ├─ 所属场站 * (必填，编辑时只读)
│  ├─ 备件描述
│  └─ 备件图片 (图片上传 + 预览)
│
├─ 用户操作
│  ├─ 输入/修改表单内容
│  ├─ 点击图片上传框 → 选择文件
│  ├─ 显示图片预览 (80x80px)
│  ├─ 点击"提交/创建"按钮
│  │  ├─ 验证表单 (name, qty, stationId 必填)
│  │  ├─ 上传图片 (FileReader → DataURL)
│  │  ├─ 调用 createPart() 或 updatePart()
│  │  └─ 返回列表页
│  └─ 点击"返回"按钮 → 放弃修改，回到列表页
│
└─ 权限验证
   └─ 前端检查: currentUser.stationId == form.stationId
      (后端必须再次验证以防止绕过)
```

## 3. 路由配置总结

| 路由路径 | 组件 | 类型 | 说明 |
|---------|------|------|------|
| `/` | 重定向到 `/parts` | 重定向 | 根路径 |
| `/login` | Login (待实现) | 认证页 | 用户登录 |
| `/parts` | PartsList | 列表页 | 备件列表，支持多场站切换 |
| `/parts/new` | PartForm | 创建页 | 创建新备件（仅限本场站） |
| `/parts/:id` | PartDetail | 详情页 | 查看备件详细信息（所有人可见） |
| `/parts/:id/edit` | PartForm | 编辑页 | 编辑备件（仅限本场站） |

## 4. 权限模型

### 查看权限
- ✅ 所有已登录用户可以查看所有场站的所有备件

### 编辑权限
- ✅ 仅可编辑自己场站的备件
- ❌ 无法编辑其他场站的备件
- ❌ 无法删除备件（如需要应添加删除功能）

### 创建权限
- ✅ 仅可在自己的场站创建新备件
- ❌ 无法为其他场站创建备件

### 实现位置
1. **前端验证**: PartsList、PartDetail、PartForm 中通过 `canEdit()` 函数判断
2. **后端验证** (待实现): API 路由中验证 JWT token 中的 userId，确保 user.stationId == part.stationId
   ```typescript
   // 后端应该这样验证
   PUT /api/parts/:id
   ├─ 验证 JWT token 合法性
   ├─ 提取 userId 和 userStationId
   ├─ 查询数据库获取 part 信息
   ├─ 比较 part.stationId == userStationId
   ├─ 如果不相等 → 返回 403 Forbidden
   └─ 如果相等 → 执行更新操作
   ```

## 5. 场景示例

### 场景 A: 用户登录后浏览备件
```
1. 用户访问 http://localhost:5174/
2. Router 检查登录状态，无 token → 重定向 /login
3. 用户输入账号密码登录
4. 登录成功，存储 token 和 user 信息
5. 自动重定向 /parts 列表页
6. PartsList 初始化，加载 user.stationId 对应的备件
7. 显示该场站的所有备件卡片
8. 用户看到"新增备件"和"编辑"按钮都是可用的（蓝色）
```

### 场景 B: 用户切换场站查看其他场站备件
```
1. 用户在列表页，当前场站是 station-1
2. 点击"当前场站"按钮
3. 弹窗显示 station-1 (✓ 我的场站) 和 station-2
4. 用户点击 station-2
5. 列表重新加载 station-2 的备件
6. "新增备件"按钮变灰（显示"仅可在自己的场站新增备件"）
7. 所有卡片上的"编辑"按钮变为"无编辑权限"（灰色，禁用）
8. 用户只能点击"详情"查看信息
```

### 场景 C: 用户编辑自己场站的备件
```
1. 用户在 station-1 的列表页
2. 点击某个备件的"编辑"按钮
3. 跳转到 /parts/:id/edit
4. PartForm 组件加载该备件数据
5. 用户修改名称、型号、数量等信息
6. 用户重新选择或上传图片
7. 点击"提交"按钮
8. 前端验证表单 (name, qty, stationId 必填)
9. 调用 updatePart() 更新 Pinia store
10. 返回列表页，看到修改后的备件信息
```

### 场景 D: 用户尝试编辑其他场站的备件（应被阻止）
```
1. 用户在 station-1，切换到 station-2 查看
2. 找到一个 station-2 的备件，点击"编辑"
3. 前端权限检查：canEdit() 返回 false
4. "编辑"按钮已禁用，无法点击
5. 即使用户手动在浏览器地址栏输入 /parts/:id/edit
6. PartForm 会检查权限，显示错误提示
7. 后端（待实现）会返回 403 Forbidden，拒绝更新
```

## 6. 待实现的功能

### 必须实现
- [ ] 登录页面 (`/login`)
- [ ] 后端 API 集成 (替换 Pinia mock 数据)
- [ ] JWT token 认证
- [ ] 后端权限验证 (403 处理)

### 可选改进
- [ ] 备件删除功能
- [ ] 批量上传功能
- [ ] 导出 Excel 功能
- [ ] 审计日志 (记录谁修改了什么)
- [ ] 图片预览和裁剪
- [ ] 高级搜索和过滤

